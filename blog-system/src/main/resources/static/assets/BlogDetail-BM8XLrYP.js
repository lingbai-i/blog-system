import{r as v,p as Se,m as Re,ag as S,c as f,o as m,a as l,P as o,L as k,H as r,u as I,M as y,G as Q,O as se,a6 as oe,J as V,n as ee,b as je,ax as He,aw as qe,a4 as Ue,V as Ke}from"./vendor-qcSz3H5x.js";import{p as Ge,q as $e,w as be,u as Ae,x as Be,o as Ne,y as Pe,a as Qe,z as u,A as Xe,B as Ye,f as Ze,n as et,t as tt,m as ze,C as at}from"./elementPlus-Cz6C--fH.js";import{a as E}from"./index-xsH4HHeE.js";import{_ as De,M as st}from"./index-CbgkKY63.js";import{H as ve}from"./index-CTYSh0L0.js";const ot={class:"comment-section"},lt={class:"comment-header"},nt={class:"comment-title"},rt={class:"comment-form-section"},it={key:0,class:"login-prompt"},ct={style:{"margin-top":"10px"}},ut={class:"image-upload-section"},dt={class:"comment-list-section"},mt={key:0,class:"loading-section"},gt={key:1,class:"empty-comments"},pt={key:2,class:"comment-list"},ft={class:"comment-content"},vt={class:"comment-header-info"},_t={class:"comment-author"},ht={class:"author-info"},kt={class:"author-name"},yt={class:"comment-time"},wt={class:"comment-actions"},It={class:"comment-text"},$t={key:0,class:"comment-images"},bt={class:"image-grid"},St={key:1,class:"reply-form"},Tt={class:"image-upload-section"},Ct={key:2,class:"replies-section"},xt={class:"reply-content"},At={class:"reply-header"},Bt={class:"reply-author-info"},Nt={class:"reply-author-name"},zt={key:0,class:"reply-to-name"},Rt={class:"reply-time"},Dt={class:"reply-text"},Lt={key:0,class:"reply-images"},Vt={class:"image-grid"},Et={class:"reply-actions"},Mt={key:1,class:"nested-reply-form"},Ft={class:"image-upload-section"},Ot={key:0,class:"toggle-replies-btn"},Jt={__name:"CommentSection",props:{blogId:{type:[String,Number],required:!0},blogAuthorId:{type:Number,required:!1}},setup(Te){const C=Te,O=v([]),te=v(0),c=v(!1),U=v(!1),K=v(!1),R=v(null),J=v(null),B=v(""),G=v(""),X=v(""),Y=v(new Set),le=v([]),W=v([]),ne=v("/api/upload/image"),ae=v({}),M=v(),Z=v(),N=v({content:"",images:[]}),$=v({content:"",images:[]}),_e=(t,e,n)=>{const i=e?e.trim():"",w=N.value.images&&N.value.images.length>0;!i&&!w?n(new Error("请输入评论内容或上传图片")):i&&i.length>500?n(new Error("评论内容不能超过 500 个字符")):n()},he=(t,e,n)=>{const i=e?e.trim():"",w=$.value.images&&$.value.images.length>0;!i&&!w?n(new Error("请输入回复内容或上传图片")):i&&i.length>300?n(new Error("回复内容不能超过 300 个字符")):n()},re={content:[{validator:_e,trigger:"blur"}]},ie={content:[{validator:he,trigger:"blur"}]},P=async()=>{if(C.blogId){c.value=!0;try{const t=await E.get(`/api/comments/blog/${C.blogId}`);t.data&&(O.value=t.data,O.value.forEach(e=>{if(e.authorAvatar&&!e.authorAvatar.startsWith("http")&&(e.authorAvatar=`http://localhost:8080${e.authorAvatar}`),e.images&&typeof e.images=="string")try{e.images=JSON.parse(e.images)}catch(n){console.warn("解析评论图片数据失败:",n),e.images=[]}else e.images||(e.images=[])}),await s())}catch(t){console.error("获取评论失败:",t),u.error("获取评论失败")}finally{c.value=!1}}},s=async()=>{for(const t of O.value)try{const e=await E.get(`/api/comments/${t.id}/replies`);e.data&&(t.replies=e.data,t.replies.length>0&&Y.value.add(t.id),t.replies.forEach(n=>{if(n.authorAvatar&&!n.authorAvatar.startsWith("http")&&(n.authorAvatar=`http://localhost:8080${n.authorAvatar}`),n.images&&typeof n.images=="string")try{n.images=JSON.parse(n.images)}catch(i){console.warn("解析回复图片数据失败:",i),n.images=[]}else n.images||(n.images=[])}))}catch(e){console.error(`获取评论 ${t.id} 的回复失败:`,e),t.replies=[]}},a=async()=>{if(C.blogId)try{const t=await E.get(`/api/comments/blog/${C.blogId}/count`);t.data&&(te.value=t.data.count||0)}catch(t){console.error("获取评论数量失败:",t),te.value=0}},d=()=>{const t=localStorage.getItem("userToken"),e=localStorage.getItem("adminToken"),n=t||e;if(!n)return!1;if(n.startsWith("token_")){const i=n.split("_");if(i.length>=3){const w=parseInt(i[2]),z=Date.now(),b=24*60*60*1e3;return z-w>b?(localStorage.removeItem("userToken"),localStorage.removeItem("adminToken"),!1):!0}}return!0},g=()=>{window.location.href="/login"},_=async()=>{var t,e,n;if(M.value){if(!d()){u.warning("请先登录后再发表评论"),g();return}try{await M.value.validate(),U.value=!0;let i=null;const w=localStorage.getItem("userToken")||localStorage.getItem("adminToken");if(w)if(w.startsWith("token_")){const T=w.split("_");if(T.length>=3){const j=parseInt(T[2]),H=Date.now(),L=24*60*60*1e3;if(H-j>L){u.error("登录已过期，请重新登录"),localStorage.removeItem("userToken"),localStorage.removeItem("adminToken"),g();return}i=parseInt(T[1])}}else try{const T=await E.get("/api/auth/profile",{headers:{Authorization:`Bearer ${w}`}});T.data&&T.data.id&&(i=T.data.id)}catch(T){console.warn("无法从token获取用户信息:",T),u.error("登录状态异常，请重新登录"),g();return}const z={blogId:C.blogId,content:N.value.content,images:JSON.stringify(N.value.images)};i&&(z.userId=i);const b=await E.post("/api/comments",z);b.data&&b.data.success?(u.success("评论提交成功"),ce(),await P(),await a()):u.error(((t=b.data)==null?void 0:t.message)||"评论提交失败")}catch(i){console.error("提交评论失败:",i),(n=(e=i.response)==null?void 0:e.data)!=null&&n.message?u.error(i.response.data.message):u.error("评论提交失败，请稍后重试")}finally{U.value=!1}}},x=async t=>{var e,n,i;if(!d()){u.warning("请先登录后再回复评论"),g();return}if(R.value!==t){u.error("表单未准备就绪，请重试");return}await ee();try{const w=$.value.content?$.value.content.trim():"",z=$.value.images&&$.value.images.length>0;if(!w&&!z){u.error("请输入回复内容或上传图片");return}if(w&&w.length>300){u.error("回复内容不能超过300个字符");return}K.value=!0;let b=null;const T=localStorage.getItem("userToken")||localStorage.getItem("adminToken");if(T)if(T.startsWith("token_")){const L=T.split("_");if(L.length>=3){const Ie=parseInt(L[2]),ge=Date.now(),pe=24*60*60*1e3;if(ge-Ie>pe){u.error("登录已过期，请重新登录"),localStorage.removeItem("userToken"),localStorage.removeItem("adminToken"),g();return}b=parseInt(L[1])}}else try{const L=await E.get("/api/auth/profile",{headers:{Authorization:`Bearer ${T}`}});L.data&&L.data.id&&(b=L.data.id)}catch(L){console.warn("无法从token获取用户信息:",L),u.error("登录状态异常，请重新登录"),g();return}const j={blogId:C.blogId,parentId:t,content:$.value.content,images:JSON.stringify($.value.images)};b&&(j.userId=b),B.value&&(j.replyToName=B.value);const H=await E.post("/api/comments/reply",j);H.data&&H.data.success?(u.success("回复发布成功！"),$.value={content:"",images:[]},W.value=[],R.value=null,J.value=null,B.value="",await P(),await a()):u.error(((e=H.data)==null?void 0:e.message)||"回复提交失败")}catch(w){console.error("提交回复失败:",w),(i=(n=w.response)==null?void 0:n.data)!=null&&i.message?u.error(w.response.data.message):u.error("回复提交失败，请稍后重试")}finally{K.value=!1}},F=async(t,e,n=null)=>{if(!d()){u.warning("请先登录后再回复评论");return}R.value=t,J.value=n,B.value=e,n?(G.value=`回复 @${e}`,X.value=`回复 @${e}...`):(G.value=`回复 ${e}`,X.value=`回复 ${e}...`),$.value={content:"",images:[]},W.value=[],await ee()},D=()=>{R.value=null,J.value=null,B.value="",$.value={content:"",images:[]},W.value=[]},ce=()=>{N.value={content:"",images:[]},le.value=[],M.value&&M.value.resetFields()},ue=t=>{if(!t)return"";const e=new Date(t),i=new Date-e;return i<6e4?"刚刚":i<36e5?`${Math.floor(i/6e4)}分钟前`:i<864e5?`${Math.floor(i/36e5)}小时前`:i<6048e5?`${Math.floor(i/864e5)}天前`:e.toLocaleDateString("zh-CN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},A=t=>{if(!d())return!1;let e=null;const n=localStorage.getItem("userToken")||localStorage.getItem("adminToken");if(n&&n.startsWith("token_")){const i=n.split("_");i.length>=3&&(e=parseInt(i[1]))}return e?!!(t.userId===e||C.blogAuthorId&&C.blogAuthorId===e):!1},de=async t=>{try{await Xe.confirm("确定要删除这条评论吗？删除后无法恢复。","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=localStorage.getItem("userToken"),n=localStorage.getItem("adminToken"),i=e||n,w={};i&&(w.headers={Authorization:`Bearer ${i}`});const z=await E.delete(`/api/comments/${t}`,w);z.data&&z.data.success?(u.success("评论删除成功"),await P(),await a()):u.error("删除失败："+(z.data.message||"未知错误"))}catch(e){if(e==="cancel")return;console.error("删除评论失败:",e),e.response&&e.response.data&&e.response.data.message?u.error("删除失败："+e.response.data.message):u.error("删除评论失败，请稍后重试")}},Le=t=>{const e=Y.value;e.has(t)?e.delete(t):e.add(t)},Ve=(t,e)=>!t||t.length===0?[]:Y.value.has(e)?[]:t,Ee=t=>t&&t.length>0,Me=(t,e)=>!t||t.length===0?"":Y.value.has(e)?`展开全部 ${t.length} 条回复`:"收起回复",Fe=()=>{const t=localStorage.getItem("userToken"),e=localStorage.getItem("adminToken"),n=t||e;n&&(ae.value={Authorization:`Bearer ${n}`})},ke=t=>{const e=t.type.startsWith("image/"),n=t.size/1024/1024<2;return e?n?(Fe(),!0):(u.error("图片大小不能超过 2MB!"),!1):(u.error("只能上传图片文件!"),!1)},Oe=(t,e)=>{t&&t.success&&t.url?(N.value.images.push(t.url),u.success("图片上传成功"),ee(()=>{M.value&&M.value.validateField("content")})):u.error("图片上传失败")},Ce=(t,e)=>{t&&t.success&&t.url?($.value.images.push(t.url),u.success("图片上传成功"),ee(()=>{Z.value&&Z.value.validateField("content")})):u.error("图片上传失败")},ye=t=>{console.error("图片上传失败:",t),u.error("图片上传失败，请重试")},Je=t=>{const e=le.value.findIndex(n=>n.uid===t.uid);e>-1&&(N.value.images.splice(e,1),ee(()=>{M.value&&M.value.validateField("content")}))},xe=t=>{const e=W.value.findIndex(n=>n.uid===t.uid);e>-1&&($.value.images.splice(e,1),ee(()=>{Z.value&&Z.value.validateField("content")}))},we=()=>{u.warning("最多只能上传3张图片")},me=t=>t?t.startsWith("http")?t:`http://localhost:8080${t}`:"";return Se(()=>C.blogId,t=>{t&&(P(),a())},{immediate:!0}),Re(()=>{C.blogId&&(P(),a())}),(t,e)=>{const n=S("el-icon"),i=S("el-button"),w=S("el-alert"),z=S("el-input"),b=S("el-form-item"),T=S("el-upload"),j=S("el-form"),H=S("el-card"),L=S("el-skeleton"),Ie=S("el-empty"),ge=S("el-avatar"),pe=S("el-image");return m(),f("div",ot,[l("div",lt,[l("h3",nt,[o(n,null,{default:r(()=>[o(I(Ge))]),_:1}),k(" 评论 ("+y(te.value)+") ",1)])]),l("div",rt,[o(H,{class:"comment-form-card"},{header:r(()=>e[3]||(e[3]=[l("span",null,"发表评论",-1)])),default:r(()=>[d()?(m(),Q(j,{key:1,model:N.value,rules:re,ref_key:"commentFormRef",ref:M},{default:r(()=>[o(b,{prop:"content"},{default:r(()=>[o(z,{modelValue:N.value.content,"onUpdate:modelValue":e[0]||(e[0]=p=>N.value.content=p),type:"textarea",rows:4,placeholder:"请输入评论内容...",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1}),o(b,{label:"图片"},{default:r(()=>[l("div",ut,[o(T,{action:ne.value,headers:ae.value,"file-list":le.value,"on-success":Oe,"on-error":ye,"on-remove":Je,"before-upload":ke,limit:3,"on-exceed":we,name:"file",accept:"image/*","list-type":"picture-card",multiple:""},{default:r(()=>[o(n,{class:"avatar-uploader-icon"},{default:r(()=>[o(I($e))]),_:1})]),_:1},8,["action","headers","file-list"]),e[5]||(e[5]=l("div",{class:"upload-tip"},[l("p",null,"支持上传jpg、png、gif格式图片，单张图片不超过2MB，最多3张")],-1))])]),_:1}),o(b,null,{default:r(()=>[o(i,{type:"primary",onClick:_,loading:U.value,icon:I(be)},{default:r(()=>e[6]||(e[6]=[k(" 发表评论 ")])),_:1,__:[6]},8,["loading","icon"]),o(i,{onClick:ce},{default:r(()=>e[7]||(e[7]=[k("重置")])),_:1,__:[7]})]),_:1})]),_:1},8,["model"])):(m(),f("div",it,[o(w,{title:"请先登录后再发表评论",type:"info",closable:!1,"show-icon":""},{default:r(()=>[l("div",ct,[o(i,{type:"primary",size:"small",onClick:g},{default:r(()=>e[4]||(e[4]=[k("去登录")])),_:1,__:[4]})])]),_:1})]))]),_:1})]),l("div",dt,[c.value?(m(),f("div",mt,[o(L,{rows:3,animated:""})])):O.value.length===0?(m(),f("div",gt,[o(Ie,{description:"暂无评论，快来发表第一条评论吧！"})])):(m(),f("div",pt,[(m(!0),f(se,null,oe(O.value,p=>(m(),f("div",{key:p.id,class:"comment-item"},[l("div",ft,[l("div",vt,[l("div",_t,[o(ge,{size:40,src:p.authorAvatar,icon:I(Ae),class:"comment-avatar"},null,8,["src","icon"]),l("div",ht,[l("span",kt,y(p.authorName),1),l("span",yt,y(ue(p.createdAt)),1)])]),l("div",wt,[o(i,{text:"",type:"primary",size:"small",onClick:h=>F(p.id,p.authorName),icon:I(Be),disabled:!d()},{default:r(()=>[k(y(d()?"回复":"登录后回复"),1)]),_:2},1032,["onClick","icon","disabled"]),A(p)?(m(),Q(i,{key:0,text:"",type:"danger",size:"small",onClick:h=>de(p.id),icon:I(Ne)},{default:r(()=>e[8]||(e[8]=[k(" 删除 ")])),_:2,__:[8]},1032,["onClick","icon"])):V("",!0)])]),l("div",It,y(p.content),1),p.images&&p.images.length>0?(m(),f("div",$t,[l("div",bt,[(m(!0),f(se,null,oe(p.images,(h,q)=>(m(),Q(pe,{key:q,src:me(h),"preview-src-list":p.images.map(fe=>me(fe)),"initial-index":q,fit:"cover",class:"comment-image","preview-teleported":""},null,8,["src","preview-src-list","initial-index"]))),128))])])):V("",!0),R.value===p.id&&!J.value?(m(),f("div",St,[o(H,null,{header:r(()=>[l("span",null,y(G.value),1)]),default:r(()=>[o(j,{model:$.value,rules:ie,ref_for:!0,ref:`replyForm_${p.id}`,"data-reply-form":p.id},{default:r(()=>[o(b,{prop:"content"},{default:r(()=>[o(z,{modelValue:$.value.content,"onUpdate:modelValue":e[1]||(e[1]=h=>$.value.content=h),type:"textarea",rows:3,placeholder:X.value,maxlength:"300","show-word-limit":""},null,8,["modelValue","placeholder"])]),_:1}),o(b,{label:"图片"},{default:r(()=>[l("div",Tt,[o(T,{action:ne.value,headers:ae.value,"file-list":W.value,"on-success":Ce,"on-error":ye,"on-remove":xe,"before-upload":ke,limit:3,"on-exceed":we,name:"file",accept:"image/*","list-type":"picture-card",multiple:""},{default:r(()=>[o(n,{class:"avatar-uploader-icon"},{default:r(()=>[o(I($e))]),_:1})]),_:1},8,["action","headers","file-list"]),e[9]||(e[9]=l("div",{class:"upload-tip"},[l("p",null,"支持上传jpg、png、gif格式图片，单张图片不超过2MB，最多3张")],-1))])]),_:1}),o(b,null,{default:r(()=>[o(i,{type:"primary",size:"small",onClick:h=>x(p.id),loading:K.value,icon:I(be)},{default:r(()=>e[10]||(e[10]=[k(" 发表回复 ")])),_:2,__:[10]},1032,["onClick","loading","icon"]),o(i,{size:"small",onClick:D},{default:r(()=>e[11]||(e[11]=[k("取消")])),_:1,__:[11]})]),_:2},1024)]),_:2},1032,["model","data-reply-form"])]),_:2},1024)])):V("",!0),p.replies&&p.replies.length>0?(m(),f("div",Ct,[(m(!0),f(se,null,oe(Ve(p.replies,p.id),h=>(m(),f("div",{key:h.id,class:"reply-item"},[l("div",xt,[l("div",At,[o(ge,{size:32,src:h.authorAvatar,icon:I(Ae),class:"reply-avatar"},null,8,["src","icon"]),l("div",Bt,[l("span",Nt,y(h.authorName),1),h.replyToName?(m(),f("span",zt,"回复 "+y(h.replyToName),1)):V("",!0),l("span",Rt,y(ue(h.createdAt)),1)])]),l("div",Dt,y(h.content),1),h.images&&h.images.length>0?(m(),f("div",Lt,[l("div",Vt,[(m(!0),f(se,null,oe(h.images,(q,fe)=>(m(),Q(pe,{key:fe,src:me(q),"preview-src-list":h.images.map(We=>me(We)),"initial-index":fe,fit:"cover",class:"reply-image","preview-teleported":""},null,8,["src","preview-src-list","initial-index"]))),128))])])):V("",!0),l("div",Et,[o(i,{text:"",type:"primary",size:"small",onClick:q=>F(p.id,h.authorName,h.id),icon:I(Be),disabled:!d()},{default:r(()=>[k(y(d()?"回复":"登录后回复"),1)]),_:2},1032,["onClick","icon","disabled"]),A(h)?(m(),Q(i,{key:0,text:"",type:"danger",size:"small",onClick:q=>de(h.id),icon:I(Ne)},{default:r(()=>e[12]||(e[12]=[k(" 删除 ")])),_:2,__:[12]},1032,["onClick","icon"])):V("",!0)]),R.value===p.id&&J.value===h.id?(m(),f("div",Mt,[o(H,null,{header:r(()=>[l("span",null,y(G.value),1)]),default:r(()=>[o(j,{model:$.value,rules:ie,ref_for:!0,ref:`nestedReplyForm_${h.id}`},{default:r(()=>[o(b,{prop:"content"},{default:r(()=>[o(z,{modelValue:$.value.content,"onUpdate:modelValue":e[2]||(e[2]=q=>$.value.content=q),type:"textarea",rows:3,placeholder:X.value,maxlength:"300","show-word-limit":""},null,8,["modelValue","placeholder"])]),_:1}),o(b,{label:"图片"},{default:r(()=>[l("div",Ft,[o(T,{action:ne.value,headers:ae.value,"file-list":W.value,"on-success":Ce,"on-error":ye,"on-remove":xe,"before-upload":ke,limit:3,"on-exceed":we,name:"file",accept:"image/*","list-type":"picture-card",multiple:""},{default:r(()=>[o(n,{class:"avatar-uploader-icon"},{default:r(()=>[o(I($e))]),_:1})]),_:1},8,["action","headers","file-list"]),e[13]||(e[13]=l("div",{class:"upload-tip"},[l("p",null,"支持上传jpg、png、gif格式图片，单张图片不超过2MB，最多3张")],-1))])]),_:1}),o(b,null,{default:r(()=>[o(i,{type:"primary",size:"small",onClick:q=>x(p.id),loading:K.value,icon:I(be)},{default:r(()=>e[14]||(e[14]=[k(" 发表回复 ")])),_:2,__:[14]},1032,["onClick","loading","icon"]),o(i,{size:"small",onClick:D},{default:r(()=>e[15]||(e[15]=[k("取消")])),_:1,__:[15]})]),_:2},1024)]),_:2},1032,["model"])]),_:2},1024)])):V("",!0)])]))),128)),Ee(p.replies)?(m(),f("div",Ot,[o(i,{text:"",type:"primary",size:"small",onClick:h=>Le(p.id),class:"toggle-btn"},{default:r(()=>[o(n,{class:"toggle-icon"},{default:r(()=>[Y.value.has(p.id)?(m(),Q(I(Pe),{key:0})):(m(),Q(I(Qe),{key:1}))]),_:2},1024),k(" "+y(Me(p.replies,p.id)),1)]),_:2},1032,["onClick"])])):V("",!0)])):V("",!0)])]))),128))]))])])}}},Wt=De(Jt,[["__scopeId","data-v-73bc1b96"]]),jt={class:"blog-detail"},Ht={class:"header"},qt={class:"container"},Ut={class:"header-content"},Kt={class:"nav"},Gt={class:"main"},Pt={class:"container"},Qt={class:"back-section"},Xt={key:0,class:"loading"},Yt={key:1,class:"error"},Zt={key:2,class:"blog-article"},ea={class:"article-header"},ta={class:"article-title"},aa={class:"article-meta"},sa={class:"meta-item author-item"},oa={class:"author-name"},la={class:"meta-item"},na={class:"meta-item"},ra={class:"meta-item"},ia={key:0,class:"article-tags"},ca=["innerHTML"],ua={class:"article-footer"},da={class:"article-actions"},ma={key:3,class:"related-section"},ga={class:"related-grid"},pa=["onClick","onKeyup"],fa={class:"related-title"},va={class:"related-summary"},_a={class:"related-meta"},ha={key:4,class:"comment-section"},ka={class:"image-preview-container"},ya=["src"],wa={__name:"BlogDetail",setup(Te){const C=qe(),O=He(),te=new st({html:!0,linkify:!0,typographer:!0,breaks:!0,highlight:function(s,a){if(a&&ve.getLanguage(a))try{const d=ve.highlight(s,{language:a,ignoreIllegals:!0});return`<pre class="hljs"><code class="hljs language-${a}">${d.value}</code></pre>`}catch{}return`<pre class="hljs"><code class="hljs">${te.utils.escapeHtml(s)}</code></pre>`}}),c=v(null),U=v([]),K=v(!1),R=v(""),J=v(!1),B=v(!1),G=v(!1),X=v(""),Y=je(()=>{var g;if(!((g=c.value)!=null&&g.content))return"";let s=c.value.content;const a=/<[^>]+>/.test(s),d=/^#{1,6}\s|\*\*.*\*\*|\*.*\*|`.*`|\[.*\]\(.*\)|^\s*[-*+]\s|^\d+\.\s/m.test(s);if(!a&&d?s=te.render(s):a?(s=s.replace(/&nbsp;/g," ").replace(/&#160;/g," "),s=s.replace(/<pre class="ql-syntax"[^>]*>([\s\S]*?)<\/pre>/g,(_,x)=>{const F=x.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&nbsp;/g," ").replace(/&#160;/g," ");try{const D=ve.highlightAuto(F);return`<pre class="hljs"><code class="hljs language-${D.language||"plaintext"}">${D.value}</code></pre>`}catch(D){return console.error("代码高亮失败:",D),`<pre class="hljs"><code class="hljs">${ve.utils.escapeHtml(F)}</code></pre>`}})):s=s.replace(/\n/g,"<br>"),c.value.images)try{const _=typeof c.value.images=="string"?JSON.parse(c.value.images):c.value.images;if(Array.isArray(_)&&_.length>0){const x=_.map((F,D)=>`<div class="article-image" data-image-url="${F}" data-image-index="${D}"><img src="${F}" alt="文章图片" class="preview-thumbnail" style="cursor: pointer;"/></div>`).join("");s+=x}}catch(_){console.error("解析图片数据失败:",_)}return s}),le=s=>{X.value=s,G.value=!0},W=async()=>{const s=O.params.id;if(!s){R.value="博客ID无效";return}K.value=!0,R.value="";try{const a=await E.get(`/api/blogs/${s}`);a.data&&a.data.id?(c.value=a.data,c.value.authorAvatar&&!c.value.authorAvatar.startsWith("http")&&(c.value.authorAvatar=`http://localhost:8080${c.value.authorAvatar}`),_e(),ne()):R.value="博客不存在或已被删除"}catch(a){console.error("获取博客详情失败:",a),R.value="获取博客详情失败，请稍后重试"}finally{K.value=!1}},ne=async()=>{try{const s=await E.get("/api/blogs/latest",{params:{limit:3}});s.data&&Array.isArray(s.data)&&(U.value=s.data.filter(a=>a.id!=O.params.id))}catch(s){console.error("获取相关文章失败:",s),U.value=[]}},ae=()=>{C.push("/")},M=()=>{document.referrer.includes("/admin")||sessionStorage.getItem("fromAdmin")==="true"?(C.push("/admin"),sessionStorage.removeItem("fromAdmin")):C.go(-1)},Z=s=>{if(console.log("点击相关文章，ID:",s),sessionStorage.getItem("fromAdmin")==="true"&&sessionStorage.setItem("fromAdmin","true"),O.params.id===s.toString()){console.log("跳转到当前页面，强制重新加载"),window.location.reload();return}C.push(`/blog/${s}`).then(()=>{console.log("路由跳转成功")}).catch(d=>{console.error("路由跳转失败:",d)})},N=()=>{const s=localStorage.getItem("userToken"),a=localStorage.getItem("adminToken"),d=s||a;if(!d)return!1;if(d.startsWith("token_")){const g=d.split("_");if(g.length>=3){const _=parseInt(g[2]),x=Date.now(),F=24*60*60*1e3;return x-_>F?(localStorage.removeItem("userToken"),localStorage.removeItem("adminToken"),!1):!0}}return!0},$=async()=>{if(!c.value||J.value)return;if(!N()){u.warning("请先登录后再操作"),C.push("/login");return}const s=localStorage.getItem("userToken")||localStorage.getItem("adminToken");if(s&&s.startsWith("token_")){const a=s.split("_");if(a.length>=3){const d=parseInt(a[2]),g=Date.now(),_=24*60*60*1e3;if(g-d>_){u.error("登录已过期，请重新登录"),localStorage.removeItem("userToken"),localStorage.removeItem("adminToken"),C.push("/login");return}}}J.value=!0;try{const a=localStorage.getItem("userToken")||localStorage.getItem("adminToken");if(!a){u.error("请先登录");return}const d={headers:{Authorization:`Bearer ${a}`}};let g;if(B.value){if(g=await E.delete(`/api/blogs/${c.value.id}/like`,d),g.data){c.value.likeCount=g.data.likeCount,B.value=!1;const _=JSON.parse(localStorage.getItem("likedBlogs")||"[]"),x=_.indexOf(c.value.id);x>-1&&(_.splice(x,1),localStorage.setItem("likedBlogs",JSON.stringify(_))),u.success("取消点赞成功！")}}else if(g=await E.post(`/api/blogs/${c.value.id}/like`,{},d),g.data){c.value.likeCount=g.data.likeCount,B.value=!0;const _=JSON.parse(localStorage.getItem("likedBlogs")||"[]");_.includes(c.value.id)||(_.push(c.value.id),localStorage.setItem("likedBlogs",JSON.stringify(_))),u.success("点赞成功！")}}catch(a){console.error("操作失败:",a),u.error("操作失败，请稍后重试")}finally{J.value=!1}},_e=async()=>{if(!c.value)return;const s=JSON.parse(localStorage.getItem("likedBlogs")||"[]"),a=s.includes(c.value.id),d=localStorage.getItem("userToken")||localStorage.getItem("adminToken");if(d)try{const g={headers:{Authorization:`Bearer ${d}`}},_=await E.get(`/api/blogs/${c.value.id}/like-status`,g);if(B.value=_.data.liked,_.data.liked&&!a)s.push(c.value.id),localStorage.setItem("likedBlogs",JSON.stringify(s));else if(!_.data.liked&&a){const x=s.indexOf(c.value.id);x>-1&&(s.splice(x,1),localStorage.setItem("likedBlogs",JSON.stringify(s)))}}catch{B.value=a}else B.value=a},he=()=>{navigator.share&&c.value?navigator.share({title:c.value.title,text:c.value.content.substring(0,100)+"...",url:window.location.href}):navigator.clipboard.writeText(window.location.href).then(()=>{u.success("链接已复制到剪贴板")}).catch(()=>{u.error("复制失败")})},re=s=>s?new Date(s).toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"}):"";Se(()=>O.params.id,(s,a)=>{s&&s!==a&&(console.log("路由参数变化，重新获取数据:",s),W())},{immediate:!0});const ie=()=>{ee(()=>{const s=document.querySelectorAll(".article-content .preview-thumbnail");console.log("找到图片数量:",s.length),s.forEach(a=>{a.addEventListener("click",d=>{console.log("图片被点击:",d.target.src);const g=d.target.src;le(g)})})})};Se(c,s=>{s&&s.images&&ie()},{immediate:!0});const P=s=>{if(!s)return[];try{if(typeof s=="string"){if(s.startsWith("[")&&s.endsWith("]")){const a=JSON.parse(s);return Array.isArray(a)?a.filter(d=>d&&d.trim()):[]}return s.split(",").map(a=>a.trim()).filter(a=>a)}if(Array.isArray(s))return s.filter(a=>a&&a.trim())}catch(a){console.error("解析标签数据失败:",a)}return[]};return Re(()=>{W()}),(s,a)=>{const d=S("router-link"),g=S("el-button"),_=S("el-skeleton"),x=S("el-result"),F=S("el-avatar"),D=S("el-icon"),ce=S("el-tag"),ue=S("el-dialog");return m(),f("div",jt,[l("header",Ht,[l("div",qt,[l("div",Ut,[l("h1",{class:"logo",onClick:ae},"文章详情"),l("nav",Kt,[o(d,{to:"/",class:"nav-link"},{default:r(()=>a[1]||(a[1]=[k("首页")])),_:1,__:[1]}),o(d,{to:"/announcements",class:"nav-link"},{default:r(()=>a[2]||(a[2]=[k("公告")])),_:1,__:[2]}),o(d,{to:"/dashboard",class:"nav-link"},{default:r(()=>a[3]||(a[3]=[k("个人中心")])),_:1,__:[3]})])])])]),l("main",Gt,[l("div",Pt,[l("div",Qt,[o(g,{onClick:M,icon:I(Ye)},{default:r(()=>a[4]||(a[4]=[k("返回")])),_:1,__:[4]},8,["icon"])]),K.value?(m(),f("div",Xt,[o(_,{rows:8,animated:""})])):R.value?(m(),f("div",Yt,[o(x,{icon:"error",title:"加载失败","sub-title":R.value},{extra:r(()=>[o(g,{type:"primary",onClick:W},{default:r(()=>a[5]||(a[5]=[k("重试")])),_:1,__:[5]})]),_:1},8,["sub-title"])])):c.value?(m(),f("article",Zt,[l("header",ea,[l("h1",ta,y(c.value.title),1),l("div",aa,[l("span",sa,[o(F,{size:32,src:c.value.authorAvatar,icon:I(Ze),class:"author-avatar"},null,8,["src","icon"]),l("span",oa,y(c.value.authorName||c.value.author),1)]),l("span",la,[o(D,null,{default:r(()=>[o(I(et))]),_:1}),k(" "+y(re(c.value.publishedAt||c.value.createdAt)),1)]),l("span",na,[o(D,null,{default:r(()=>[o(I(tt))]),_:1}),k(" 热度 "+y(c.value.viewCount||c.value.views||0),1)]),l("span",ra,[o(D,null,{default:r(()=>[o(I(ze))]),_:1}),k(" "+y(c.value.likeCount||0)+" 点赞 ",1)])]),c.value.tags&&P(c.value.tags).length>0?(m(),f("div",ia,[(m(!0),f(se,null,oe(P(c.value.tags),A=>(m(),Q(ce,{key:A,size:"small",class:"tag"},{default:r(()=>[k(y(A.trim()),1)]),_:2},1024))),128))])):V("",!0)]),l("div",{class:"article-content",innerHTML:Y.value},null,8,ca),l("footer",ua,[l("div",da,[o(g,{onClick:$,icon:I(ze),loading:J.value,type:B.value?"danger":"primary",disabled:!N()},{default:r(()=>[k(y(B.value?"取消点赞":N()?"点赞":"登录后点赞")+" ("+y(c.value.likeCount||0)+") ",1)]),_:1},8,["icon","loading","type","disabled"]),o(g,{onClick:he,icon:I(at)},{default:r(()=>a[6]||(a[6]=[k("分享")])),_:1,__:[6]},8,["icon"]),o(g,{onClick:M},{default:r(()=>a[7]||(a[7]=[k("返回列表")])),_:1,__:[7]})])])])):V("",!0),U.value.length>0?(m(),f("section",ma,[a[8]||(a[8]=l("h2",{class:"section-title"},"相关文章",-1)),l("div",ga,[(m(!0),f(se,null,oe(U.value,A=>(m(),f("div",{key:A.id,class:"related-card",onClick:Ke(de=>Z(A.id),["stop"]),role:"button",tabindex:"0",onKeyup:Ue(de=>Z(A.id),["enter"])},[l("h3",fa,y(A.title),1),l("p",va,y(A.summary||A.content.substring(0,100)+"..."),1),l("div",_a,[l("span",null,y(re(A.publishedAt||A.createdAt)),1)])],40,pa))),128))])])):V("",!0),c.value?(m(),f("section",ha,[o(Wt,{"blog-id":c.value.id,"blog-author-id":c.value.userId},null,8,["blog-id","blog-author-id"])])):V("",!0)])]),o(ue,{modelValue:G.value,"onUpdate:modelValue":a[0]||(a[0]=A=>G.value=A),title:"图片预览",width:"80%","show-close":!0,center:""},{default:r(()=>[l("div",ka,[l("img",{src:X.value,alt:"预览图片",class:"preview-image"},null,8,ya)])]),_:1},8,["modelValue"])])}}},Ca=De(wa,[["__scopeId","data-v-d026270a"]]);export{Ca as default};
