import{r as k,w as Z,p as ie,c as g,o as m,a,P as i,L as p,H as c,u as $,ag as w,M as v,G as Y,O as ee,a6 as te,J as M,q as oe,b as ue,aA as de,az as me,a4 as _e,V as fe}from"./vendor-DAHo6VuW.js";import{k as ge,l as se,u as ne,m as pe,j as re,n as u,o as ve,p as he,b as ke,g as le,q as ye,e as we,t as Ie}from"./elementPlus-Da0LKy-i.js";import{a as T}from"./index-xsH4HHeE.js";import{_ as ce}from"./index-C_Y6TLtC.js";const be={class:"comment-section"},$e={class:"comment-header"},Se={class:"comment-title"},Ce={class:"comment-form-section"},Te={key:0,class:"login-prompt"},Ae={style:{"margin-top":"10px"}},xe={class:"comment-list-section"},Be={key:0,class:"loading-section"},De={key:1,class:"empty-comments"},Ne={key:2,class:"comment-list"},ze={class:"comment-content"},Le={class:"comment-header-info"},Ve={class:"comment-author"},Ee={class:"author-info"},Re={class:"author-name"},Oe={class:"comment-time"},Fe={class:"comment-actions"},Me={class:"comment-text"},qe={key:0,class:"reply-form"},Je={key:1,class:"replies-section"},We={class:"reply-content"},He={class:"reply-header"},Ue={class:"reply-author-info"},je={class:"reply-author-name"},Ke={class:"reply-time"},Pe={class:"reply-text"},Ge={class:"reply-actions"},Qe={__name:"CommentSection",props:{blogId:{type:[String,Number],required:!0},blogAuthorId:{type:Number,required:!1}},setup(ae){const y=ae,x=k([]),n=k(0),E=k(!1),R=k(!1),B=k(!1),D=k(null),S=k();k();const L=k({content:""}),C=k({content:""}),j={content:[{required:!0,message:"请输入评论内容",trigger:"blur"},{min:1,max:500,message:"评论内容长度在 1 到 500 个字符",trigger:"blur"}]},K={content:[{required:!0,message:"请输入回复内容",trigger:"blur"},{min:1,max:300,message:"回复内容长度在 1 到 300 个字符",trigger:"blur"}]},V=async()=>{if(y.blogId){E.value=!0;try{const t=await T.get(`/api/comments/blog/${y.blogId}`);t.data&&(x.value=t.data,x.value.forEach(e=>{e.authorAvatar&&!e.authorAvatar.startsWith("http")&&(e.authorAvatar=`http://localhost:8080${e.authorAvatar}`)}),await P())}catch(t){console.error("获取评论失败:",t),u.error("获取评论失败")}finally{E.value=!1}}},P=async()=>{for(const t of x.value)try{const e=await T.get(`/api/comments/${t.id}/replies`);e.data&&(t.replies=e.data,t.replies.forEach(l=>{l.authorAvatar&&!l.authorAvatar.startsWith("http")&&(l.authorAvatar=`http://localhost:8080${l.authorAvatar}`)}))}catch(e){console.error(`获取评论 ${t.id} 的回复失败:`,e),t.replies=[]}},O=async()=>{if(y.blogId)try{const t=await T.get(`/api/comments/blog/${y.blogId}/count`);t.data&&(n.value=t.data.count||0)}catch(t){console.error("获取评论数量失败:",t),n.value=0}},N=()=>{const t=localStorage.getItem("userToken"),e=localStorage.getItem("adminToken"),l=t||e;if(!l)return!1;if(l.startsWith("token_")){const r=l.split("_");if(r.length>=3){const _=parseInt(r[2]),I=Date.now(),b=24*60*60*1e3;return I-_>b?(localStorage.removeItem("userToken"),localStorage.removeItem("adminToken"),!1):!0}}return!0},z=()=>{window.location.href="/login"},q=async()=>{var t,e,l;if(S.value){if(!N()){u.warning("请先登录后再发表评论"),z();return}try{await S.value.validate(),R.value=!0;let r=null;const _=localStorage.getItem("userToken")||localStorage.getItem("adminToken");if(_)if(_.startsWith("token_")){const f=_.split("_");if(f.length>=3){const d=parseInt(f[2]),F=Date.now(),W=24*60*60*1e3;if(F-d>W){u.error("登录已过期，请重新登录"),localStorage.removeItem("userToken"),localStorage.removeItem("adminToken"),z();return}r=parseInt(f[1])}}else try{const f=await T.get("/api/auth/profile",{headers:{Authorization:`Bearer ${_}`}});f.data&&f.data.id&&(r=f.data.id)}catch(f){console.warn("无法从token获取用户信息:",f),u.error("登录状态异常，请重新登录"),z();return}const I={blogId:y.blogId,content:L.value.content};r&&(I.userId=r);const b=await T.post("/api/comments",I);b.data&&b.data.success?(u.success("评论提交成功"),J(),await V(),await O()):u.error(((t=b.data)==null?void 0:t.message)||"评论提交失败")}catch(r){console.error("提交评论失败:",r),(l=(e=r.response)==null?void 0:e.data)!=null&&l.message?u.error(r.response.data.message):u.error("评论提交失败，请稍后重试")}finally{R.value=!1}}},G=async t=>{var e,l,r;if(!N()){u.warning("请先登录后再回复评论"),z();return}if(D.value!==t){u.error("表单未准备就绪，请重试");return}await oe();try{if(!C.value.content||C.value.content.trim()===""){u.error("请输入回复内容");return}if(C.value.content.length>300){u.error("回复内容不能超过300个字符");return}B.value=!0;let _=null;const I=localStorage.getItem("userToken")||localStorage.getItem("adminToken");if(I)if(I.startsWith("token_")){const d=I.split("_");if(d.length>=3){const F=parseInt(d[2]),W=Date.now(),U=24*60*60*1e3;if(W-F>U){u.error("登录已过期，请重新登录"),localStorage.removeItem("userToken"),localStorage.removeItem("adminToken"),z();return}_=parseInt(d[1])}}else try{const d=await T.get("/api/auth/profile",{headers:{Authorization:`Bearer ${I}`}});d.data&&d.data.id&&(_=d.data.id)}catch(d){console.warn("无法从token获取用户信息:",d),u.error("登录状态异常，请重新登录"),z();return}const b={blogId:y.blogId,parentId:t,content:C.value.content};_&&(b.userId=_);const f=await T.post("/api/comments/reply",b);f.data&&f.data.success?(u.success("回复发布成功！"),C.value.content="",D.value=null,await V(),await O()):u.error(((e=f.data)==null?void 0:e.message)||"回复提交失败")}catch(_){console.error("提交回复失败:",_),(r=(l=_.response)==null?void 0:l.data)!=null&&r.message?u.error(_.response.data.message):u.error("回复提交失败，请稍后重试")}finally{B.value=!1}},Q=async t=>{if(!N()){u.warning("请先登录后再回复评论");return}D.value=t,C.value={authorName:"",authorEmail:"",content:""},await oe()},X=()=>{D.value=null,C.value={content:""}},J=()=>{L.value={content:""},S.value&&S.value.resetFields()},H=t=>{if(!t)return"";const e=new Date(t),r=new Date-e;return r<6e4?"刚刚":r<36e5?`${Math.floor(r/6e4)}分钟前`:r<864e5?`${Math.floor(r/36e5)}小时前`:r<6048e5?`${Math.floor(r/864e5)}天前`:e.toLocaleDateString("zh-CN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},s=t=>{if(!N())return!1;let e=null;const l=localStorage.getItem("userToken")||localStorage.getItem("adminToken");if(l&&l.startsWith("token_")){const r=l.split("_");r.length>=3&&(e=parseInt(r[1]))}return e?!!(t.user&&t.user.id===e||y.blogAuthorId&&y.blogAuthorId===e):!1},o=async t=>{try{await ve.confirm("确定要删除这条评论吗？删除后无法恢复。","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await T.delete(`/api/comments/${t}`);e.data&&e.data.success?(u.success("评论删除成功"),await V(),await O()):u.error("删除失败："+(e.data.message||"未知错误"))}catch(e){if(e==="cancel")return;console.error("删除评论失败:",e),e.response&&e.response.data&&e.response.data.message?u.error("删除失败："+e.response.data.message):u.error("删除评论失败，请稍后重试")}};return Z(()=>y.blogId,t=>{t&&(V(),O())},{immediate:!0}),ie(()=>{y.blogId&&(V(),O())}),(t,e)=>{const l=w("el-icon"),r=w("el-button"),_=w("el-alert"),I=w("el-input"),b=w("el-form-item"),f=w("el-form"),d=w("el-card"),F=w("el-skeleton"),W=w("el-empty"),U=w("el-avatar");return m(),g("div",be,[a("div",$e,[a("h3",Se,[i(l,null,{default:c(()=>[i($(ge))]),_:1}),p(" 评论 ("+v(n.value)+") ",1)])]),a("div",Ce,[i(d,{class:"comment-form-card"},{header:c(()=>e[2]||(e[2]=[a("span",null,"发表评论",-1)])),default:c(()=>[N()?(m(),Y(f,{key:1,model:L.value,rules:j,ref_key:"commentFormRef",ref:S},{default:c(()=>[i(b,{prop:"content"},{default:c(()=>[i(I,{modelValue:L.value.content,"onUpdate:modelValue":e[0]||(e[0]=h=>L.value.content=h),type:"textarea",rows:4,placeholder:"请输入评论内容...",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1}),i(b,null,{default:c(()=>[i(r,{type:"primary",onClick:q,loading:R.value,icon:$(se)},{default:c(()=>e[4]||(e[4]=[p(" 发表评论 ")])),_:1,__:[4]},8,["loading","icon"]),i(r,{onClick:J},{default:c(()=>e[5]||(e[5]=[p("重置")])),_:1,__:[5]})]),_:1})]),_:1},8,["model"])):(m(),g("div",Te,[i(_,{title:"请先登录后再发表评论",type:"info",closable:!1,"show-icon":""},{default:c(()=>[a("div",Ae,[i(r,{type:"primary",size:"small",onClick:z},{default:c(()=>e[3]||(e[3]=[p("去登录")])),_:1,__:[3]})])]),_:1})]))]),_:1})]),a("div",xe,[E.value?(m(),g("div",Be,[i(F,{rows:3,animated:""})])):x.value.length===0?(m(),g("div",De,[i(W,{description:"暂无评论，快来发表第一条评论吧！"})])):(m(),g("div",Ne,[(m(!0),g(ee,null,te(x.value,h=>(m(),g("div",{key:h.id,class:"comment-item"},[a("div",ze,[a("div",Le,[a("div",Ve,[i(U,{size:40,src:h.authorAvatar,icon:$(ne),class:"comment-avatar"},null,8,["src","icon"]),a("div",Ee,[a("span",Re,v(h.authorName),1),a("span",Oe,v(H(h.createdAt)),1)])]),a("div",Fe,[i(r,{text:"",type:"primary",size:"small",onClick:A=>Q(h.id),icon:$(pe),disabled:!N()},{default:c(()=>[p(v(N()?"回复":"登录后回复"),1)]),_:2},1032,["onClick","icon","disabled"]),s(h)?(m(),Y(r,{key:0,text:"",type:"danger",size:"small",onClick:A=>o(h.id),icon:$(re)},{default:c(()=>e[6]||(e[6]=[p(" 删除 ")])),_:2,__:[6]},1032,["onClick","icon"])):M("",!0)])]),a("div",Me,v(h.content),1),D.value===h.id?(m(),g("div",qe,[i(d,null,{header:c(()=>[a("span",null,"回复 "+v(h.authorName),1)]),default:c(()=>[i(f,{model:C.value,rules:K,ref_for:!0,ref:`replyForm_${h.id}`,"data-reply-form":h.id},{default:c(()=>[i(b,{prop:"content"},{default:c(()=>[i(I,{modelValue:C.value.content,"onUpdate:modelValue":e[1]||(e[1]=A=>C.value.content=A),type:"textarea",rows:3,placeholder:"请输入回复内容...",maxlength:"300","show-word-limit":""},null,8,["modelValue"])]),_:1}),i(b,null,{default:c(()=>[i(r,{type:"primary",size:"small",onClick:A=>G(h.id),loading:B.value,icon:$(se)},{default:c(()=>e[7]||(e[7]=[p(" 发表回复 ")])),_:2,__:[7]},1032,["onClick","loading","icon"]),i(r,{size:"small",onClick:X},{default:c(()=>e[8]||(e[8]=[p("取消")])),_:1,__:[8]})]),_:2},1024)]),_:2},1032,["model","data-reply-form"])]),_:2},1024)])):M("",!0),h.replies&&h.replies.length>0?(m(),g("div",Je,[(m(!0),g(ee,null,te(h.replies,A=>(m(),g("div",{key:A.id,class:"reply-item"},[a("div",We,[a("div",He,[i(U,{size:32,src:A.authorAvatar,icon:$(ne),class:"reply-avatar"},null,8,["src","icon"]),a("div",Ue,[a("span",je,v(A.authorName),1),a("span",Ke,v(H(A.createdAt)),1)])]),a("div",Pe,v(A.content),1),a("div",Ge,[s(A)?(m(),Y(r,{key:0,text:"",type:"danger",size:"small",onClick:Bt=>o(A.id),icon:$(re)},{default:c(()=>e[9]||(e[9]=[p(" 删除 ")])),_:2,__:[9]},1032,["onClick","icon"])):M("",!0)])])]))),128))])):M("",!0)])]))),128))]))])])}}},Xe=ce(Qe,[["__scopeId","data-v-430409cc"]]),Ye={class:"blog-detail"},Ze={class:"header"},et={class:"container"},tt={class:"header-content"},ot={class:"nav"},at={class:"main"},st={class:"container"},nt={class:"back-section"},rt={key:0,class:"loading"},lt={key:1,class:"error"},it={key:2,class:"blog-article"},ct={class:"article-header"},ut={class:"article-title"},dt={class:"article-meta"},mt={class:"meta-item author-item"},_t={class:"author-name"},ft={class:"meta-item"},gt={class:"meta-item"},pt={class:"meta-item"},vt=["innerHTML"],ht={class:"article-footer"},kt={class:"article-actions"},yt={key:3,class:"related-section"},wt={class:"related-grid"},It=["onClick","onKeyup"],bt={class:"related-title"},$t={class:"related-summary"},St={class:"related-meta"},Ct={key:4,class:"comment-section"},Tt={class:"image-preview-container"},At=["src"],xt={__name:"BlogDetail",setup(ae){const y=me(),x=de(),n=k(null),E=k([]),R=k(!1),B=k(""),D=k(!1),S=k(!1),L=k(!1),C=k(""),j=ue(()=>{var o;if(!((o=n.value)!=null&&o.content))return"";let s=n.value.content.split(`
`).filter(t=>t.trim()).map(t=>`<p>${t}</p>`).join("");if(n.value.images)try{const t=typeof n.value.images=="string"?JSON.parse(n.value.images):n.value.images;if(Array.isArray(t)&&t.length>0){const e=t.map((l,r)=>`<div class="article-image" data-image-url="${l}" data-image-index="${r}"><img src="${l}" alt="文章图片" class="preview-thumbnail" style="cursor: pointer;"/></div>`).join("");s+=e}}catch(t){console.error("解析图片数据失败:",t)}return s}),K=s=>{C.value=s,L.value=!0},V=async()=>{const s=x.params.id;if(!s){B.value="博客ID无效";return}R.value=!0,B.value="";try{const o=await T.get(`/api/blogs/${s}`);o.data&&o.data.id?(n.value=o.data,n.value.authorAvatar&&!n.value.authorAvatar.startsWith("http")&&(n.value.authorAvatar=`http://localhost:8080${n.value.authorAvatar}`),Q(),P()):B.value="博客不存在或已被删除"}catch(o){console.error("获取博客详情失败:",o),B.value="获取博客详情失败，请稍后重试"}finally{R.value=!1}},P=async()=>{try{const s=await T.get("/api/blogs/latest",{params:{limit:3}});s.data&&Array.isArray(s.data)&&(E.value=s.data.filter(o=>o.id!=x.params.id))}catch(s){console.error("获取相关文章失败:",s),E.value=[]}},O=()=>{y.push("/")},N=()=>{document.referrer.includes("/admin")||sessionStorage.getItem("fromAdmin")==="true"?(y.push("/admin"),sessionStorage.removeItem("fromAdmin")):y.go(-1)},z=s=>{if(console.log("点击相关文章，ID:",s),sessionStorage.getItem("fromAdmin")==="true"&&sessionStorage.setItem("fromAdmin","true"),x.params.id===s.toString()){console.log("跳转到当前页面，强制重新加载"),window.location.reload();return}y.push(`/blog/${s}`).then(()=>{console.log("路由跳转成功")}).catch(t=>{console.error("路由跳转失败:",t)})},q=()=>{const s=localStorage.getItem("userToken"),o=localStorage.getItem("adminToken"),t=s||o;if(!t)return!1;if(t.startsWith("token_")){const e=t.split("_");if(e.length>=3){const l=parseInt(e[2]),r=Date.now(),_=24*60*60*1e3;return r-l>_?(localStorage.removeItem("userToken"),localStorage.removeItem("adminToken"),!1):!0}}return!0},G=async()=>{if(!n.value||D.value)return;if(!q()){u.warning("请先登录后再操作"),y.push("/login");return}const s=localStorage.getItem("userToken")||localStorage.getItem("adminToken");if(s&&s.startsWith("token_")){const o=s.split("_");if(o.length>=3){const t=parseInt(o[2]),e=Date.now(),l=24*60*60*1e3;if(e-t>l){u.error("登录已过期，请重新登录"),localStorage.removeItem("userToken"),localStorage.removeItem("adminToken"),y.push("/login");return}}}D.value=!0;try{const o=localStorage.getItem("userToken")||localStorage.getItem("adminToken");if(!o){u.error("请先登录");return}const t={headers:{Authorization:`Bearer ${o}`}};let e;if(S.value){if(e=await T.delete(`/api/blogs/${n.value.id}/like`,t),e.data){n.value.likeCount=e.data.likeCount,S.value=!1;const l=JSON.parse(localStorage.getItem("likedBlogs")||"[]"),r=l.indexOf(n.value.id);r>-1&&(l.splice(r,1),localStorage.setItem("likedBlogs",JSON.stringify(l))),u.success("取消点赞成功！")}}else if(e=await T.post(`/api/blogs/${n.value.id}/like`,{},t),e.data){n.value.likeCount=e.data.likeCount,S.value=!0;const l=JSON.parse(localStorage.getItem("likedBlogs")||"[]");l.includes(n.value.id)||(l.push(n.value.id),localStorage.setItem("likedBlogs",JSON.stringify(l))),u.success("点赞成功！")}}catch(o){console.error("操作失败:",o),u.error("操作失败，请稍后重试")}finally{D.value=!1}},Q=async()=>{if(!n.value)return;const s=JSON.parse(localStorage.getItem("likedBlogs")||"[]"),o=s.includes(n.value.id),t=localStorage.getItem("userToken")||localStorage.getItem("adminToken");if(t)try{const e={headers:{Authorization:`Bearer ${t}`}},l=await T.get(`/api/blogs/${n.value.id}/like-status`,e);if(S.value=l.data.liked,l.data.liked&&!o)s.push(n.value.id),localStorage.setItem("likedBlogs",JSON.stringify(s));else if(!l.data.liked&&o){const r=s.indexOf(n.value.id);r>-1&&(s.splice(r,1),localStorage.setItem("likedBlogs",JSON.stringify(s)))}}catch{S.value=o}else S.value=o},X=()=>{navigator.share&&n.value?navigator.share({title:n.value.title,text:n.value.content.substring(0,100)+"...",url:window.location.href}):navigator.clipboard.writeText(window.location.href).then(()=>{u.success("链接已复制到剪贴板")}).catch(()=>{u.error("复制失败")})},J=s=>s?new Date(s).toLocaleDateString("zh-CN",{year:"numeric",month:"long",day:"numeric"}):"";Z(()=>x.params.id,(s,o)=>{s&&s!==o&&(console.log("路由参数变化，重新获取数据:",s),V())},{immediate:!0});const H=()=>{oe(()=>{const s=document.querySelectorAll(".article-content .preview-thumbnail");console.log("找到图片数量:",s.length),s.forEach(o=>{o.addEventListener("click",t=>{console.log("图片被点击:",t.target.src);const e=t.target.src;K(e)})})})};return Z(n,s=>{s&&s.images&&H()},{immediate:!0}),ie(()=>{V()}),(s,o)=>{var f;const t=w("router-link"),e=w("el-button"),l=w("el-skeleton"),r=w("el-result"),_=w("el-avatar"),I=w("el-icon"),b=w("el-dialog");return m(),g("div",Ye,[a("header",Ze,[a("div",et,[a("div",tt,[a("h1",{class:"logo",onClick:O},"文章详情"),a("nav",ot,[i(t,{to:"/",class:"nav-link"},{default:c(()=>o[1]||(o[1]=[p("首页")])),_:1,__:[1]}),i(t,{to:"/dashboard",class:"nav-link"},{default:c(()=>o[2]||(o[2]=[p("个人中心")])),_:1,__:[2]})])])])]),a("main",at,[a("div",st,[a("div",nt,[i(e,{onClick:N,icon:$(he)},{default:c(()=>o[3]||(o[3]=[p("返回")])),_:1,__:[3]},8,["icon"])]),R.value?(m(),g("div",rt,[i(l,{rows:8,animated:""})])):B.value?(m(),g("div",lt,[i(r,{icon:"error",title:"加载失败","sub-title":B.value},{extra:c(()=>[i(e,{type:"primary",onClick:V},{default:c(()=>o[4]||(o[4]=[p("重试")])),_:1,__:[4]})]),_:1},8,["sub-title"])])):n.value?(m(),g("article",it,[a("header",ct,[a("h1",ut,v(n.value.title),1),a("div",dt,[a("span",mt,[i(_,{size:32,src:n.value.authorAvatar,icon:$(ke),class:"author-avatar"},null,8,["src","icon"]),a("span",_t,v(n.value.authorName||n.value.author),1)]),a("span",ft,[i(I,null,{default:c(()=>[i($(we))]),_:1}),p(" "+v(J(n.value.publishedAt||n.value.createdAt)),1)]),a("span",gt,[i(I,null,{default:c(()=>[i($(Ie))]),_:1}),p(" 热度 "+v(n.value.viewCount||n.value.views||0),1)]),a("span",pt,[i(I,null,{default:c(()=>[i($(le))]),_:1}),p(" "+v(n.value.likeCount||0)+" 点赞 ",1)])])]),a("div",{class:"article-content",innerHTML:j.value},null,8,vt),a("footer",ht,[a("div",kt,[i(e,{onClick:G,icon:$(le),loading:D.value,type:S.value?"danger":"primary",disabled:!q()},{default:c(()=>[p(v(S.value?"取消点赞":q()?"点赞":"登录后点赞")+" ("+v(n.value.likeCount||0)+") ",1)]),_:1},8,["icon","loading","type","disabled"]),i(e,{onClick:X,icon:$(ye)},{default:c(()=>o[5]||(o[5]=[p("分享")])),_:1,__:[5]},8,["icon"]),i(e,{onClick:N},{default:c(()=>o[6]||(o[6]=[p("返回列表")])),_:1,__:[6]})])])])):M("",!0),E.value.length>0?(m(),g("section",yt,[o[7]||(o[7]=a("h2",{class:"section-title"},"相关文章",-1)),a("div",wt,[(m(!0),g(ee,null,te(E.value,d=>(m(),g("div",{key:d.id,class:"related-card",onClick:fe(F=>z(d.id),["stop"]),role:"button",tabindex:"0",onKeyup:_e(F=>z(d.id),["enter"])},[a("h3",bt,v(d.title),1),a("p",$t,v(d.summary||d.content.substring(0,100)+"..."),1),a("div",St,[a("span",null,v(J(d.publishedAt||d.createdAt)),1)])],40,It))),128))])])):M("",!0),n.value?(m(),g("section",Ct,[i(Xe,{"blog-id":n.value.id,"blog-author-id":(f=n.value.user)==null?void 0:f.id},null,8,["blog-id","blog-author-id"])])):M("",!0)])]),i(b,{modelValue:L.value,"onUpdate:modelValue":o[0]||(o[0]=d=>L.value=d),title:"图片预览",width:"80%","show-close":!0,center:""},{default:c(()=>[a("div",Tt,[a("img",{src:C.value,alt:"预览图片",class:"preview-image"},null,8,At)])]),_:1},8,["modelValue"])])}}},Vt=ce(xt,[["__scopeId","data-v-24a19649"]]);export{Vt as default};
