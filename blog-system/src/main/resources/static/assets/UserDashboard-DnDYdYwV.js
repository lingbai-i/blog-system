import{r as w,X as U,b as _t,m as pt,c as d,o as r,a as e,M as c,P as o,H as i,ag as v,u as f,J as h,L as _,O as L,a6 as D,G as J,aw as vt,D as gt}from"./vendor-qcSz3H5x.js";import{j as ft,k as ht,K as kt,w as F,f as G,q as yt,z as m,n as bt,v as St,A as K}from"./elementPlus-Cz6C--fH.js";import{a as k}from"./index-xsH4HHeE.js";import{_ as wt}from"./index-CbgkKY63.js";const It={class:"user-dashboard"},At={class:"header"},Ct={class:"container"},Bt={class:"header-content"},$t={class:"user-info"},Lt={class:"welcome"},Dt={class:"main"},Ut={class:"container"},zt={class:"dashboard-content"},Pt={class:"sidebar"},Tt={class:"content"},Vt={key:0,class:"content-section"},Et={class:"section-header"},xt={key:0,class:"loading"},Ht={key:1,class:"empty"},Rt={key:2,class:"blog-list"},Mt={class:"blog-info"},Nt=["onClick"],Ot={class:"blog-summary"},jt={class:"blog-meta"},Ft={class:"meta-item"},Wt={class:"meta-item"},qt={class:"blog-actions"},Jt={key:1,class:"content-section"},Gt={class:"redirect-section"},Kt={class:"redirect-card"},Xt={key:2,class:"content-section"},Qt={key:0,class:"loading"},Yt={key:1,class:"statistics-content"},Zt={class:"stats-card"},te={class:"stats-grid"},ee={class:"stat-item"},se={class:"stat-number"},ae={class:"stat-item"},oe={class:"stat-number"},le={class:"stat-item"},ie={class:"stat-number"},ne={key:0,class:"category-stats"},re={class:"category-list"},de={class:"category-name"},ce={class:"category-count"},ue={class:"stats-card"},me={class:"stats-grid"},_e={class:"stat-item"},pe={class:"stat-number"},ve={class:"stat-item"},ge={class:"stat-number"},fe={class:"stat-item"},he={class:"stat-number"},ke={class:"stat-item"},ye={class:"stat-number"},be={key:0,class:"top-articles"},Se={class:"article-list"},we=["onClick"],Ie={class:"article-views"},Ae={key:1,class:"top-articles"},Ce={class:"article-list"},Be=["onClick"],$e={class:"article-likes"},Le={class:"stats-card"},De={class:"stats-grid"},Ue={class:"stat-item"},ze={class:"stat-number"},Pe={key:0,class:"liked-articles"},Te={class:"article-list"},Ve=["onClick"],Ee={class:"article-author"},xe={class:"article-date"},He={key:0,class:"show-more"},Re={key:1,class:"article-list"},Me=["onClick"],Ne={class:"article-author"},Oe={class:"article-date"},je={key:1,class:"empty-liked"},Fe={key:3,class:"content-section"},We={class:"avatar-upload"},qe={class:"upload-actions"},Je={__name:"UserDashboard",setup(Ge){const z=vt(),I=w("my-blogs"),H=w(!1),W=w(),R=w(!1),y=U({username:"",email:"",role:"user",createdAt:""}),n=U({username:"",email:"",bio:"",avatar:""}),X=_t(()=>{const s=localStorage.getItem("userToken")||localStorage.getItem("adminToken");return s?{Authorization:`Bearer ${s}`}:{}}),Q={username:[{required:!0,message:"请输入用户名",trigger:"blur"},{min:2,max:20,message:"用户名长度在 2 到 20 个字符",trigger:"blur"}],email:[{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],bio:[{max:100,message:"简介长度不能超过个字符",trigger:"blur"}]},P=w([]),M=w(!1),T=w(!1),A=U({totalPublished:0,totalDrafts:0,thisMonthCount:0,categoryStats:[]}),g=U({totalViews:0,totalLikes:0,averageViews:0,averageLikes:0,topViewedArticles:[],topLikedArticles:[]}),q=U({totalLikedArticles:0}),C=w([]),Y=s=>{if(s==="home"){z.push("/");return}I.value=s,s==="my-blogs"?N():s==="statistics"&&dt()},Z=async()=>{try{const s=localStorage.getItem("userToken")||localStorage.getItem("adminToken");console.log("Token found:",!!s);const t=s?{headers:{Authorization:`Bearer ${s}`}}:{},l=await k.get("/api/auth/profile",t);Object.assign(y,l.data),console.log("User info from API:",l.data),n.username=l.data.username||"",n.email=l.data.email||"",n.bio=l.data.bio||"";const u=l.data.avatar_url||"";n.avatar=u&&!u.startsWith("http")?`http://localhost:8080${u}`:u}catch(s){console.warn("获取用户信息失败:",s);const t=localStorage.getItem("username"),l=localStorage.getItem("userRole");if(console.log("Username from localStorage:",t),console.log("UserRole from localStorage:",l),t){const u={username:t,email:"",bio:"",role:l||"user",createdAt:""};Object.assign(y,u),console.log("User info set from localStorage:",u),n.username=t,n.email="",n.bio="",n.avatar=""}else console.error("No username found in localStorage"),n.email="",n.bio=""}},N=async()=>{H.value=!0;try{const s=localStorage.getItem("userToken")||localStorage.getItem("adminToken"),t=s?{headers:{Authorization:`Bearer ${s}`}}:{},l=await k.get("/api/blogs/my",t);P.value=l.data.content||l.data||[]}catch(s){console.warn("获取文章列表失败:",s),P.value=[]}finally{H.value=!1}},tt=s=>{sessionStorage.setItem("editingBlog",JSON.stringify(s)),z.push("/publish")},et=()=>{z.push("/publish")},st=async s=>{try{const t=localStorage.getItem("userToken")||localStorage.getItem("adminToken"),l=t?{headers:{Authorization:`Bearer ${t}`}}:{},u=s.status==="PUBLISHED"?"unpublish":"publish";await k.put(`/api/blogs/${s.id}/${u}`,{},l),s.status=s.status==="PUBLISHED"?"DRAFT":"PUBLISHED",m.success(s.status==="PUBLISHED"?"文章已发布":"文章已取消发布")}catch{m.error("操作失败，请稍后重试")}},at=async s=>{try{await K.confirm("确定要删除这篇文章吗？","确认删除",{type:"warning"});const t=localStorage.getItem("userToken")||localStorage.getItem("adminToken"),l=t?{headers:{Authorization:`Bearer ${t}`}}:{};await k.delete(`/api/blogs/${s.id}`,l),m.success("文章删除成功"),N()}catch(t){t!=="cancel"&&m.error("删除失败，请稍后重试")}},ot=async()=>{try{await W.value.validate(),R.value=!0;const s=localStorage.getItem("userToken")||localStorage.getItem("adminToken"),t=s?{headers:{Authorization:`Bearer ${s}`}}:{},l=await k.put("/api/auth/profile",{username:n.username,email:n.email,bio:n.bio,avatar:n.avatar},t);y.username=n.username,y.email=n.email,y.bio=n.bio,y.avatar=n.avatar,localStorage.setItem("username",n.username),m.success("个人资料更新成功")}catch(s){if(s.response)m.error(s.response.data.message||"更新失败");else{if(s.errors)return;m.error("网络错误，请稍后重试")}}finally{R.value=!1}},B=s=>{console.log("用户后台点击文章，ID:",s),z.push(`/blog/${s}`)},V=s=>s?new Date(s).toLocaleDateString("zh-CN"):"",lt=s=>{const t=s.type.startsWith("image/"),l=s.size/1024/1024<2;return t?l?!0:(m.error("上传头像图片大小不能超过 2MB!"),!1):(m.error("只能上传图片文件!"),!1)},it=s=>{if(s.success&&s.url){const t=s.url.startsWith("http")?s.url:`http://localhost:8080${s.url}`;n.avatar=t,m.success("头像上传成功")}else m.error(s.message||"头像上传失败")},nt=s=>{console.error("头像上传失败:",s),m.error("头像上传失败，请稍后重试")},rt=async()=>{try{if(await K.confirm("确定要删除头像吗？","确认删除",{type:"warning"}),n.avatar){const s=localStorage.getItem("userToken")||localStorage.getItem("adminToken"),t=s?{headers:{Authorization:`Bearer ${s}`}}:{};try{await k.delete("/api/upload/delete",{...t,data:{url:n.avatar}})}catch(l){console.warn("删除服务器文件失败:",l)}}n.avatar="",m.success("头像删除成功")}catch(s){s!=="cancel"&&m.error("删除头像失败")}},dt=async()=>{var s;M.value=!0;try{const t=localStorage.getItem("userToken")||localStorage.getItem("adminToken"),l=t?{headers:{Authorization:`Bearer ${t}`}}:{},b=(await k.get("/api/auth/profile",l)).data;if(!b.id||b.id===0){console.warn("用户ID无效，跳过统计数据获取"),m.warning("请先登录以查看统计数据");return}const[p,E,x,O]=await Promise.all([k.get(`/api/user-statistics/publish/${b.username}`,l),k.get(`/api/user-statistics/popularity/${b.username}`,l),k.get(`/api/user-statistics/likes/${b.id}`,l),k.get(`/api/user-statistics/liked-articles/${b.id}`,l)]);Object.assign(A,p.data),Object.assign(g,E.data),Object.assign(q,x.data),C.value=((s=O.data)==null?void 0:s.content)||[]}catch(t){console.warn("获取统计数据失败:",t),m.error("获取统计数据失败，请稍后重试")}finally{M.value=!1}};return pt(()=>{Z(),N()}),(s,t)=>{const l=v("el-icon"),u=v("el-menu-item"),b=v("el-menu"),p=v("el-button"),E=v("el-skeleton"),x=v("el-empty"),O=v("el-tag"),ct=v("el-avatar"),ut=v("el-upload"),$=v("el-form-item"),j=v("el-input"),mt=v("el-form");return r(),d("div",It,[e("header",At,[e("div",Ct,[e("div",Bt,[t[5]||(t[5]=e("h1",{class:"logo"},"个人博客 - 用户后台",-1)),e("div",$t,[e("span",Lt,"欢迎，"+c(y.username),1)])])])]),e("main",Dt,[e("div",Ut,[e("div",zt,[e("aside",Pt,[o(b,{"default-active":I.value,class:"sidebar-menu",onSelect:Y},{default:i(()=>[o(u,{index:"home"},{default:i(()=>[o(l,null,{default:i(()=>[o(f(ft))]),_:1}),t[6]||(t[6]=e("span",null,"首页",-1))]),_:1,__:[6]}),o(u,{index:"my-blogs"},{default:i(()=>[o(l,null,{default:i(()=>[o(f(ht))]),_:1}),t[7]||(t[7]=e("span",null,"我的发布",-1))]),_:1,__:[7]}),o(u,{index:"statistics"},{default:i(()=>[o(l,null,{default:i(()=>[o(f(kt))]),_:1}),t[8]||(t[8]=e("span",null,"个人统计",-1))]),_:1,__:[8]}),o(u,{index:"create-blog"},{default:i(()=>[o(l,null,{default:i(()=>[o(f(F))]),_:1}),t[9]||(t[9]=e("span",null,"写文章",-1))]),_:1,__:[9]}),o(u,{index:"profile"},{default:i(()=>[o(l,null,{default:i(()=>[o(f(G))]),_:1}),t[10]||(t[10]=e("span",null,"个人资料",-1))]),_:1,__:[10]})]),_:1},8,["default-active"])]),e("div",Tt,[I.value==="my-blogs"?(r(),d("div",Vt,[e("div",Et,[t[12]||(t[12]=e("h2",null,"我的发布",-1)),o(p,{type:"primary",onClick:t[0]||(t[0]=a=>I.value="create-blog")},{default:i(()=>[o(l,null,{default:i(()=>[o(f(yt))]),_:1}),t[11]||(t[11]=_(" 写新文章 "))]),_:1,__:[11]})]),H.value?(r(),d("div",xt,[o(E,{rows:3,animated:""})])):P.value.length===0?(r(),d("div",Ht,[o(x,{description:"还没有发布，快去写一篇吧！"})])):(r(),d("div",Rt,[(r(!0),d(L,null,D(P.value,a=>(r(),d("div",{key:a.id,class:"blog-item"},[e("div",Mt,[e("h3",{class:gt(["blog-title",{clickable:a.status==="PUBLISHED"}]),onClick:S=>a.status==="PUBLISHED"?B(a.id):null},c(a.title),11,Nt),e("p",Ot,c(a.summary),1),e("div",jt,[e("span",Ft,[o(l,null,{default:i(()=>[o(f(bt))]),_:1}),_(" "+c(V(a.status==="PUBLISHED"&&a.publishedAt||a.createdAt)),1)]),e("span",Wt,[o(l,null,{default:i(()=>[o(f(St))]),_:1}),_(" "+c(a.viewCount||0),1)]),o(O,{type:a.status==="PUBLISHED"?"success":"warning",size:"small"},{default:i(()=>[_(c(a.status==="PUBLISHED"?"已发布":"草稿"),1)]),_:2},1032,["type"])])]),e("div",qt,[a.status==="PUBLISHED"?(r(),J(p,{key:0,size:"small",type:"primary",onClick:S=>B(a.id)},{default:i(()=>t[13]||(t[13]=[_(" 查看 ")])),_:2,__:[13]},1032,["onClick"])):h("",!0),o(p,{size:"small",onClick:S=>tt(a)},{default:i(()=>t[14]||(t[14]=[_("编辑")])),_:2,__:[14]},1032,["onClick"]),o(p,{size:"small",type:a.status==="PUBLISHED"?"warning":"success",onClick:S=>st(a)},{default:i(()=>[_(c(a.status==="PUBLISHED"?"取消发布":"发布"),1)]),_:2},1032,["type","onClick"]),o(p,{size:"small",type:"danger",onClick:S=>at(a)},{default:i(()=>t[15]||(t[15]=[_("删除")])),_:2,__:[15]},1032,["onClick"])])]))),128))]))])):h("",!0),I.value==="create-blog"?(r(),d("div",Jt,[e("div",Gt,[e("div",Kt,[o(l,{class:"redirect-icon"},{default:i(()=>[o(f(F))]),_:1}),t[17]||(t[17]=e("h2",null,"写新文章",-1)),t[18]||(t[18]=e("p",null,"点击下方按钮跳转到专业的文章编辑页面",-1)),o(p,{type:"primary",size:"large",onClick:et},{default:i(()=>[o(l,null,{default:i(()=>[o(f(F))]),_:1}),t[16]||(t[16]=_(" 开始写作 "))]),_:1,__:[16]})])])])):h("",!0),I.value==="statistics"?(r(),d("div",Xt,[t[34]||(t[34]=e("div",{class:"section-header"},[e("h2",null,"个人统计")],-1)),M.value?(r(),d("div",Qt,[o(E,{rows:5,animated:""})])):(r(),d("div",Yt,[e("div",Zt,[t[23]||(t[23]=e("h3",null,"发布统计",-1)),e("div",te,[e("div",ee,[e("div",se,c(A.totalPublished),1),t[19]||(t[19]=e("div",{class:"stat-label"},"已发布文章",-1))]),e("div",ae,[e("div",oe,c(A.totalDrafts),1),t[20]||(t[20]=e("div",{class:"stat-label"},"草稿文章",-1))]),e("div",le,[e("div",ie,c(A.thisMonthCount),1),t[21]||(t[21]=e("div",{class:"stat-label"},"本月发布",-1))])]),A.categoryStats&&A.categoryStats.length>0?(r(),d("div",ne,[t[22]||(t[22]=e("h4",null,"分类统计",-1)),e("div",re,[(r(!0),d(L,null,D(A.categoryStats,a=>(r(),d("div",{key:a.category,class:"category-item"},[e("span",de,c(a.category||"未分类"),1),e("span",ce,c(a.count)+"篇",1)]))),128))])])):h("",!0)]),e("div",ue,[t[30]||(t[30]=e("h3",null,"热度统计",-1)),e("div",me,[e("div",_e,[e("div",pe,c(g.totalViews),1),t[24]||(t[24]=e("div",{class:"stat-label"},"总浏览量",-1))]),e("div",ve,[e("div",ge,c(g.totalLikes),1),t[25]||(t[25]=e("div",{class:"stat-label"},"总点赞数",-1))]),e("div",fe,[e("div",he,c(g.avgViews),1),t[26]||(t[26]=e("div",{class:"stat-label"},"平均浏览量",-1))]),e("div",ke,[e("div",ye,c(g.avgLikes),1),t[27]||(t[27]=e("div",{class:"stat-label"},"平均点赞数",-1))])]),g.topViewedArticles&&g.topViewedArticles.length>0?(r(),d("div",be,[t[28]||(t[28]=e("h4",null,"最受欢迎文章（按浏览量）",-1)),e("div",Se,[(r(!0),d(L,null,D(g.topViewedArticles,a=>(r(),d("div",{key:a.id,class:"article-item"},[e("span",{class:"article-title",onClick:S=>B(a.id)},c(a.title),9,we),e("span",Ie,c(a.viewCount)+"次浏览",1)]))),128))])])):h("",!0),g.topLikedArticles&&g.topLikedArticles.length>0?(r(),d("div",Ae,[t[29]||(t[29]=e("h4",null,"最受欢迎文章（按点赞数）",-1)),e("div",Ce,[(r(!0),d(L,null,D(g.topLikedArticles,a=>(r(),d("div",{key:a.id,class:"article-item"},[e("span",{class:"article-title",onClick:S=>B(a.id)},c(a.title),9,Be),e("span",$e,c(a.likeCount)+"个赞",1)]))),128))])])):h("",!0)]),e("div",Le,[t[33]||(t[33]=e("h3",null,"我的点赞",-1)),e("div",De,[e("div",Ue,[e("div",ze,c(q.totalLikedArticles),1),t[31]||(t[31]=e("div",{class:"stat-label"},"点赞文章数",-1))])]),C.value&&C.value.length>0?(r(),d("div",Pe,[t[32]||(t[32]=e("h4",null,"我点赞的文章",-1)),e("div",Te,[(r(!0),d(L,null,D(C.value.slice(0,10),a=>(r(),d("div",{key:a.id,class:"article-item"},[e("span",{class:"article-title",onClick:S=>B(a.id)},c(a.title),9,Ve),e("span",Ee,"作者："+c(a.authorName),1),e("span",xe,c(V(a.likedAt)),1)]))),128))]),C.value.length>10?(r(),d("div",He,[o(p,{text:"",onClick:t[1]||(t[1]=a=>T.value=!T.value)},{default:i(()=>[_(c(T.value?"收起":`查看全部${C.value.length}篇`),1)]),_:1})])):h("",!0),T.value?(r(),d("div",Re,[(r(!0),d(L,null,D(C.value.slice(10),a=>(r(),d("div",{key:a.id,class:"article-item"},[e("span",{class:"article-title",onClick:S=>B(a.id)},c(a.title),9,Me),e("span",Ne,"作者："+c(a.authorName),1),e("span",Oe,c(V(a.likedAt)),1)]))),128))])):h("",!0)])):(r(),d("div",je,[o(x,{description:"还没有点赞任何文章"})]))])]))])):h("",!0),I.value==="profile"?(r(),d("div",Fe,[t[38]||(t[38]=e("h2",null,"个人资料",-1)),o(mt,{ref_key:"profileFormRef",ref:W,model:n,rules:Q,"label-width":"80px",class:"profile-form"},{default:i(()=>[o($,{label:"头像"},{default:i(()=>[e("div",We,[o(ct,{size:80,src:n.avatar||"/default-avatar.png",class:"avatar-preview"},{default:i(()=>[o(l,null,{default:i(()=>[o(f(G))]),_:1})]),_:1},8,["src"]),e("div",qe,[o(ut,{action:"/api/upload/avatar",headers:X.value,"show-file-list":!1,"on-success":it,"on-error":nt,"before-upload":lt,name:"file",accept:"image/*"},{default:i(()=>[o(p,{size:"small",type:"primary"},{default:i(()=>t[35]||(t[35]=[_("上传头像")])),_:1,__:[35]})]),_:1},8,["headers"]),n.avatar?(r(),J(p,{key:0,size:"small",type:"danger",onClick:rt},{default:i(()=>t[36]||(t[36]=[_(" 删除头像 ")])),_:1,__:[36]})):h("",!0)])])]),_:1}),o($,{label:"用户名",prop:"username"},{default:i(()=>[o(j,{modelValue:n.username,"onUpdate:modelValue":t[2]||(t[2]=a=>n.username=a),placeholder:"请输入用户名",clearable:""},null,8,["modelValue"])]),_:1}),o($,{label:"邮箱",prop:"email"},{default:i(()=>[o(j,{modelValue:n.email,"onUpdate:modelValue":t[3]||(t[3]=a=>n.email=a),placeholder:"请输入邮箱地址（可选）",clearable:""},null,8,["modelValue"])]),_:1}),o($,{label:"简介",prop:"bio"},{default:i(()=>[o(j,{modelValue:n.bio,"onUpdate:modelValue":t[4]||(t[4]=a=>n.bio=a),type:"textarea",rows:4,placeholder:"请输入个人简介（可选，最多500字）",maxlength:"500","show-word-limit":"",clearable:""},null,8,["modelValue"])]),_:1}),o($,{label:"注册时间"},{default:i(()=>[e("span",null,c(V(y.createdAt)),1)]),_:1}),o($,null,{default:i(()=>[o(p,{type:"primary",onClick:ot,loading:R.value},{default:i(()=>t[37]||(t[37]=[_(" 保存资料 ")])),_:1,__:[37]},8,["loading"])]),_:1})]),_:1},8,["model"])])):h("",!0)])])])])])}}},Ze=wt(Je,[["__scopeId","data-v-9c03e052"]]);export{Ze as default};
